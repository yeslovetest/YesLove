tribe.events=tribe.events||{},tribe.events.facebookSettingsAdmin=tribe.events.facebookSettingsAdmin||{},function(e,a){const t=e(document);a.GraphVersion="v9.0",a.selectors={messageWrap:".tribe-events-virtual-settings-message__wrap",facebookContainer:".tribe-settings-facebook-integration",facebookSaveApp:".tribe-settings-facebook-application__connect-container",facebookSaveAppBtn:".tribe-settings-facebook-application__connect-button",facebookPages:".tribe-settings-facebook-application-pages__container",facebookPageList:".tribe-settings-facebook-page-list",facebookAddPage:".tribe-events-virtual-meetings-facebook-settings__add-page-button",facebookPageContainer:".tribe-settings-facebook-page-details__container",facebookAppMessageContainer:".tec-facebook-app-messages",facebookPageMessageContainer:".tec-facebook-page-messages",facebookPageName:".tribe-settings-facebook-page-details__page-name-input",facebookPageId:".tribe-settings-facebook-page-details__page-id-input",facebookAccessToken:".tribe-settings-facebook-page-details__page-access-token-input",facebookClearAccess:".tribe-settings-facebook-page-details__clear-access",facebookDeletePage:".tribe-settings-facebook-page-details__delete-page",facebookSavePage:".tribe-settings-facebook-page-details__save-page",facebookAppId:'input[name="tribe_facebook_app_id"]',facebookAppSecret:'input[name="tribe_facebook_app_secret"]'},a.onAppSaveSuccess=function(t){const s=e(t).filter(a.selectors.messageWrap),o=e(t).filter(a.selectors.facebookPages);e(a.selectors.facebookAppMessageContainer).html(s),0!==o.length&&e(a.selectors.facebookSaveApp).replaceWith(o)},a.handleSaveApp=function(t){t.preventDefault();const s=e(this).data("ajaxSaveUrl"),o=e(a.selectors.facebookAppId).val(),c=e(a.selectors.facebookAppSecret).val();e.ajax(s,{contentType:"application/json",context:e(this).closest(a.selectors.facebookContainer),data:{facebook_app_id:o,facebook_app_secret:c},success:a.onAppSaveSuccess})},a.handleEnableSave=function(){const t=e(this).closest(a.selectors.facebookPageContainer),s=t.find(a.selectors.facebookPageName).val(),o=t.find(a.selectors.facebookPageId).val(),c=t.find(a.selectors.facebookSavePage);c.prop("disabled",!0),s&&o&&c.prop("disabled",!1)},a.onPageSaveSuccess=function(s){const o=e(s).filter(a.selectors.messageWrap),c=e(s).filter(a.selectors.facebookPageContainer);if(e(a.selectors.facebookPageMessageContainer).html(o),0===c.length)return;const n=c.data("localId");t.find(`[data-local-id='${n}']`).replaceWith(c),FB.XFBML.parse()},a.handleSavePage=function(t){t.preventDefault();const s=e(this),o=s.data("ajaxSaveUrl"),c=s.closest(a.selectors.facebookPageContainer),n=c.data("localId"),i=c.find(a.selectors.facebookPageName).val(),r=c.find(a.selectors.facebookPageId).val(),l=c.find(a.selectors.facebookAccessToken).val();e.ajax(o,{contentType:"application/json",context:e(this).closest(a.selectors.facebookPageContainer),data:{local_id:n,page_name:i,page_id:r,access_token:l},success:a.onPageSaveSuccess})},a.handleClearAccess=function(t){t.preventDefault();const s=e(this),o=s.attr("href"),c=s.closest(a.selectors.facebookPageContainer),n=c.data("localId");confirm(tribe_events_virtual_facebook_settings_strings.pageClearAccessConfirmation)&&e.ajax(o,{contentType:"application/json",context:c,data:{local_id:n},success:a.onPageSaveSuccess})},a.onPageDeleteSuccess=function(t){e(a.selectors.facebookPageMessageContainer).html(t),e(`${a.selectors.facebookPageContainer}.to-delete`).remove()},a.handleDeletePage=function(t){t.preventDefault();const s=e(this),o=s.data("ajaxDeleteUrl"),c=s.closest(a.selectors.facebookPageContainer),n=c.data("localId");confirm(tribe_events_virtual_facebook_settings_strings.pageDeleteConfirmation)&&(c.addClass("to-delete"),e.ajax(o,{contentType:"application/json",context:e(this).closest(a.selectors.facebookPageContainer),data:{local_id:n},success:a.onPageDeleteSuccess}))},a.facebookInit=function(){const t=e(a.selectors.facebookAppId).val();t<1||FB.init({appId:t,autoLogAppEvents:!0,xfbml:!0,version:a.GraphVersion})},a.displayMessage=function(t,s="updated"){const o=`\n\t\t\t<div\n\t\t\t\tid="tribe-events-virtual-settings-message"\n\t\t\t\tclass="tribe-events-virtual-settings-message__wrap ${s}"\n\t\t\t>\n\t\t\t\t${t}\n\t\t\t</div>\n\t\t`;e(a.selectors.facebookPageMessageContainer).html(o)},a.handleSavePageAccess=function(t,s,o,c){const n=s.data("ajaxSaveAccessUrl");e.ajax(n,{contentType:"application/json",context:s,data:{local_id:t,page_id:o,access_token:c},success:a.onPageSaveSuccess})},a.getPageAccessToken=function(t,s,o){e.ajax({url:`https://graph.facebook.com/${t}?fields=access_token&access_token=${s}`,type:"GET",dataType:"json",success:function(e){if(void 0!==e.access_token)o.find(a.selectors.facebookAccessToken).val(e.access_token),a.handleSavePageAccess(o.data("localId"),o,t,e.access_token);else{const e=tribe_events_virtual_facebook_settings_strings.pageTokenFailure,t="no page access token";a.displayMessage(`${e}: ${t}`,"error")}},error:function(e,t,s){const o=tribe_events_virtual_facebook_settings_strings.pageTokenFailure;a.displayMessage(`${o}: ${s}`,"error")}})},a.getExtendedAccessToken=function(t,s,o,c,n){if(t&&s&&o&&c&&n)e.ajax({url:`https://graph.facebook.com/oauth/access_token?grant_type=fb_exchange_token&client_id=${t}&client_secret=${s}&fb_exchange_token=${o}`,type:"GET",dataType:"json",success:function(e){if(void 0!==e.access_token)a.getPageAccessToken(c,e.access_token,n);else{const e=tribe_events_virtual_facebook_settings_strings.userTokenFailure,t="no user access token";a.displayMessage(`${e}: ${t}`,"error")}},error:function(e,t,s){const o=tribe_events_virtual_facebook_settings_strings.userTokenFailure;a.displayMessage(`${o}: ${s}`,"error")}});else{const e=tribe_events_virtual_facebook_settings_strings.userTokenFailure,t="missing parameter";a.displayMessage(`${e}: ${t}`,"error")}},a.facebookAuthorization=function(t){if(t.length<1)return void a.displayMessage(tribe_events_virtual_facebook_settings_strings.localIdFailure,"error");const s=e(a.selectors.facebookContainer).find(`[data-local-id='${t}']`);void 0!==s?FB.getLoginStatus(function(t){if("connected"!==t.status)return void a.displayMessage(tribe_events_virtual_facebook_settings_strings.connectionFailure,"error");const o=t.authResponse.accessToken,c=e(a.selectors.facebookAppId).val(),n=e(a.selectors.facebookAppSecret).val(),i=s.find(a.selectors.facebookPageId).val();a.getExtendedAccessToken(c,n,o,i,s)}):a.displayMessage(tribe_events_virtual_facebook_settings_strings.pageWrapFailure,"error")},a.onAddPageSuccess=function(t){const s=e(t).filter(a.selectors.messageWrap),o=e(t).filter(a.selectors.facebookPageContainer);e(a.selectors.facebookPageMessageContainer).html(s),0!==o.length&&e(a.selectors.facebookPageList).append(o)},a.handleAddPage=function(t){t.preventDefault();const s=e(this).attr("href");e.ajax(s,{contentType:"application/json",context:e(a.selectors.facebookPageList),success:a.onAddPageSuccess})},a.bindEvents=function(){t.on("change",`${a.selectors.facebookPageName}, ${a.selectors.facebookPageId}`,a.handleEnableSave).on("click",a.selectors.facebookSaveAppBtn,a.handleSaveApp).on("click",a.selectors.facebookSavePage,a.handleSavePage).on("click",a.selectors.facebookClearAccess,a.handleClearAccess).on("click",a.selectors.facebookDeletePage,a.handleDeletePage),e(a.selectors.facebookContainer).on("click",a.selectors.facebookAddPage,a.handleAddPage)},a.ready=function(){a.bindEvents(),window.facebookAsyncInit=a.facebookInit()},e(a.ready)}(jQuery,tribe.events.facebookSettingsAdmin);