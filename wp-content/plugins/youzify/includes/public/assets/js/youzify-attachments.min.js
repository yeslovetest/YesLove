!function(y){"use strict";y(document).ready(function(){var t=0,n=null;y.ajaxPrefilter(function(a,e,t){if(e.hasOwnProperty("data")&&e.data.hasOwnProperty("action")){var i=e.data.action;if("new_activity_comment"==i)0!=(n=y("#ac-form-"+e.data.form_id).find('input[name="attachments_files[]"]').map(function(a,e){return y(e).val()}).get()).length&&(a.data+="&attachments_files="+n,""==e.data.content&&(a.data+="&content={{{youzify_comment_attachment}}}"));else if("messages_send_reply"==i){var n;0!=(n=y("#send-reply").find('input[name="attachments_files[]"]').map(function(a,e){return y(e).val()}).get()).length&&(a.data+="&attachments_files="+n,""==e.data.content&&(a.data+="&content={{{youzify_message_attachment}}}"))}}}),y(document).ajaxSuccess(function(a,e,t){if("[object String]"==Object.prototype.toString.call(t.data)){var i=e.responseText;if(i[0]+i[1]!="-1"){var n=y.youzify_getUrlParameter(t.data,"action");"new_activity_comment"==n?(y("#ac-form-"+y.youzify_getUrlParameter(t.data,"form_id")).find(".youzify-delete-attachment").trigger("click"),y("#ac-form-"+y.youzify_getUrlParameter(t.data,"form_id")).find(".youzify-wall-upload-btn").fadeIn()):"messages_send_reply"==n&&(y("#send-reply").find(".youzify-delete-attachment").trigger("click"),y("#send-reply").find(".youzify-upload-btn").fadeIn())}}}),y(document).on("change",".youzify-upload-attachments",function(a){a.preventDefault();var e=y(this).closest("form");if(e.hasClass("ac-form")&&(e.find(".youzify-wall-upload-btn").fadeOut(),e.find(".youzify-attachment-item")[0]))return!1;var t=y(this).closest(".youzify-attachments"),i=t.find(".youzify-wall-item-upload");if(i[0]&&(i.fadeOut(1),t.find(".youzify-attachment-item")[0]))return!1;n=y(this).get(0),y.youzify_UploadFiles(e,t,{attachments:n})}),y.youzify_UploadFiles=function(a,e,t){for(var i=y.extend({},t).attachments.files,n=0;n<i.length;n++){var o=i[n];if(a.hasClass("youzify-wall-form")){if(!y.youzify_CheckFilesNumber(a))return!1}else if(a.find(".youzify-attachment-item")[0])return!1;var f=y.youzifyAttachmentItem({file:o,input_name:e.attr("data-name")?e.attr("data-name"):"attachments_files[]",file_name:o.name});a.hasClass("ac-form")?a.find(".youzify-wall-upload-btn").fadeOut(1):"send-reply"!=a.attr("id")&&"send_message_form"!=a.attr("id")||a.find(".youzify-upload-btn").fadeOut(1),e.find(".youzify-form-attachments").append(f),0==n&&y.youzify_UploadFile(a,e,o)}},y.youzifyAttachmentItem=function(a){var e,t,i=y.extend({},a);return e='<div class="youzify-attachment-item youzify-file-preview"><div class="youzify-attachment-details"><i class="fas fa-hourglass-half youzify-file-icon"></i><span class="youzify-file-name">'+y.youzify_GetNameExcerpt(i.file_name)+'</span></div><div class="youzify-file-progress"><span class="youzify-file-upload"></span></div><input type="hidden" class="youzify-attachment-data" name="'+i.input_name+'" /></div>',t='<div class="youzify-attachment-item youzify-image-preview"><div class="youzify-attachment-details"><i class="fas fa-hourglass-half youzify-file-icon"></i></div><div class="youzify-file-progress"><span class="youzify-file-upload"></span></div><input type="hidden" class="youzify-attachment-data" name="'+i.input_name+'" /></div>',y.youzify_CheckIsFileImage(i.file)?t:e},y.youzify_UploadFile=function(n,o,f){var s=o.find(".youzify-file-progress:first").parent(".youzify-attachment-item"),a=new FormData;a.append("file",f),n.hasClass("youzify-wall-form")?(a.append("target","activity"),a.append("post_type",n.find('input:radio[name="post_type"]:checked').val())):n.hasClass("ac-form")?a.append("target","comment"):"send-reply"!=n.closest("form").attr("id")&&"send_message_form"!=n.closest("form").attr("id")||a.append("target","message"),a.append("attachments_number",n.find(".youzify-attachment-item").length),a.append("action","youzify_upload_wall_attachments"),a.append("security",Youzify.security_nonce),y.ajax({type:"POST",url:Youzify.ajax_url,data:a,cache:!1,contentType:!1,processData:!1,xhr:function(){var a=y.ajaxSettings.xhr();return a.upload&&(n.find(".youzify-wall-post,.youzify-update-post").attr("disabled",!0),a.upload.addEventListener("progress",function(a){if(a.lengthComputable){var e=a.total,t=100*a.loaded/e,i=s.find(".youzify-file-upload");s.find(".youzify-file-icon").attr("class","fas fa-spinner fa-spin youzify-file-icon"),i.css("width",t+"%"),100<=t&&i.addClass("youzify-file-uploaded")}})),a},success:function(a){if(0==a.success)return y.youzify_DialogMsg("error",a.data.error),n.hasClass("ac-form")?n.find(".youzify-wall-upload-btn").fadeIn():"send-reply"!=n.attr("id")&&"send_message_form"!=n.attr("id")||n.find(".youzify-upload-btn").fadeIn(),o.hasClass("youzify-cf-attachment")&&o.find(".youzify-wall-item-upload").fadeIn(),s.remove(),y.youzify_CheckUploadProgress(n),!1;var e=a.data.base_url;s.find(".youzify-file-progress").fadeOut(400,function(){y(this).remove(),y.youzify_upload_next_file(n,o),y.youzify_CheckUploadProgress(n)}),y.youzify_CheckIsFileImage(f)&&s.find(".youzify-file-icon").remove(),s.find(".youzify-file-icon").attr("class","fas fa-paperclip youzify-file-icon"),s.find(".youzify-attachment-details").append('<i class="fas fa-trash-alt youzify-delete-attachment"></i>'),delete a.data.base_url,s.find(".youzify-attachment-data").val(JSON.stringify(a.data));var i=new FileReader;f.type.match("video.*")&&(i.onload=function(){var a=new Blob([i.result],{type:f.type}),n=URL.createObjectURL(a),o=document.createElement("video"),e=function(){t()&&(o.removeEventListener("timeupdate",e),o.pause())};o.addEventListener("loadeddata",function(){t()&&o.removeEventListener("timeupdate",e)});var t=function(){var a=document.createElement("canvas");a.width=o.videoWidth,a.height=o.videoHeight,a.getContext("2d").drawImage(o,0,0,a.width,a.height);var e=a.toDataURL("image/jpeg"),t=1e5<e.length;if(t){var i=JSON.parse(s.find(".youzify-attachment-data").val());i.video_thumbnail=e,s.find(".youzify-attachment-data").val(JSON.stringify(i)),URL.revokeObjectURL(n)}return t};o.addEventListener("timeupdate",e),o.preload="metadata",o.src=n,o.muted=!0,o.playsInline=!0,o.play()},i.readAsArrayBuffer(f)),s.css("background-image","url("+e+"temp/"+a.data.original+")")},error:function(a,e,t){s.remove(),y.youzify_DialogMsg("error",e),y.youzify_CheckUploadProgress(n),y.youzify_upload_next_file(n,o)}})},y.youzify_upload_next_file=function(a,e){t++,null!==n&&void 0!==n.files[t]&&y.youzify_UploadFile(a,e,n.files[t])},y(document).on("click",".youzify-delete-attachment",function(a){var e=y(this).closest("form");e.hasClass("ac-form")?e.find(".youzify-wall-upload-btn").fadeIn():"send-reply"!=e.attr("id")&&"send_message_form"!=e.attr("id")||e.find(".youzify-upload-btn").fadeIn(),y(this).closest(".youzify-attachments").find(".youzify-wall-item-upload").fadeIn();var t=y(this).closest(".youzify-attachment-item");if(t.find(".youzify-attachment-data").get(0)){var i=y.parseJSON(t.find(".youzify-attachment-data").val());y.youzify_DeleteAttachment(i.original)}t.remove()}),y.youzify_DeleteAttachment=function(a){var e=new FormData;e.append("attachment",a),e.append("security",Youzify.security_nonce),e.append("action","youzify_delete_wall_attachment"),y.ajax({type:"POST",data:e,url:ajaxurl,contentType:!1,processData:!1})},y.youzify_GetNameExcerpt=function(a){if(a.length<=25)return a;var e=25-"...".length,t=Math.ceil(e/2),i=Math.floor(e/2);return a.substr(0,t)+"..."+a.substr(a.length-i)},y.youzify_CheckIsFileImage=function(a){var e=a.type;return!(y.inArray(e,["image/gif","image/jpeg","image/png"])<0)},y.youzify_CheckUploadProgress=function(a){a.find(".youzify-file-progress")[0]||(a.find(".youzify-upload-attachments").val(""),a.find('.youzify-wall-actions button[type="submit"]').attr("disabled",!1),t=0,n=null)},y.youzify_CheckFilesNumber=function(a){var e=a.find('input:radio[name="post_type"]:checked').val();return"activity_photo"==e||"activity_poll"==e||"activity_slideshow"==e||!a.find(".youzify-attachment-item")[0]||(n=null,y.youzify_DialogMsg("error",Youzify_Wall.max_one_file),!1)}})}(jQuery);